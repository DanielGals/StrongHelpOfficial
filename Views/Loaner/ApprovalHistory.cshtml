@model LoanApplicationDetailsViewModel
@{
    ViewData["Title"] = "Approval History";
    ViewBag.IdParamName = "loanId";
    ViewBag.LoanID = Model.LoanID;
    ViewBag.Status = Model.ApplicationStatus;
    ViewBag.TabArea = "";
}

@section Styles {
    <link rel="stylesheet" href="~/css/LoanApplicationDetails.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/MyApplication.css" asp-append-version="true" />
}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
    <div>
        <h2 class="fw-bold mb-1">Approval History</h2>
        <div class="text-muted mb-2" style="font-size:1em;">Current Status and details of your application</div>
    </div>
</div>

@{
    ViewBag.LoanID = Model.LoanID;
    ViewBag.Status = Model.ApplicationStatus;
}
@await Html.PartialAsync("_LoanApplicationTabs")

@{
    var ba = Model.Approvers?.FirstOrDefault(a => a.RoleName.Contains("Benefits Assistant"));
    var allOthers = Model.Approvers?
        .Where(a => !a.RoleName.Contains("Benefits Assistant"))
        .OrderBy(a => a.Order)
        .ToList() ?? new List<ApprovalViewModel>();
    
    var others = new List<ApprovalViewModel>();
    foreach (var approver in allOthers)
    {
        others.Add(approver);
        if (approver.Status == "Rejected" || approver.Status == "Pending")
            break;
    }
    
    // Check co-maker status
    bool coMakerRejected = Model.ApplicationStatus == "Rejected" && 
                           !string.IsNullOrEmpty(Model.Remarks) && 
                           Model.Remarks.Contains("Rejected by Co-maker");
    bool coMakerApproved = !string.IsNullOrEmpty(Model.CoMakerName) && 
                           Model.ApplicationStatus != "Drafted" && 
                           !coMakerRejected;
}

@if (others != null)
{
    foreach (var approval in others)
    {
        var isRejected = approval.Status == "Rejected";
        var isApproved = approval.Status == "Approved";
        var isPending = approval.Status == "Pending";
        var lineColor = isRejected ? "#dc3545" : (isApproved ? "#28a745" : "#3243c0");
        
        var displayText = isPending
            ? $"Currently reviewing by {approval.ApproverName} on {Model.DateSubmitted.ToString("yyyy-MM-dd")}"
            : $"{approval.Status} by {approval.ApproverName} on {approval.ApprovedDate?.ToString("yyyy-MM-dd")}";
        
        <div class="approval-history-item" style="border-left: 3px solid @lineColor; padding-left: 1rem; margin-bottom: 2rem;">
            <div class="loan-details-label" style="margin-bottom:0.1em; color: @lineColor; font-weight: bold;">
                @approval.RoleName @(isPending ? "Review" : approval.Status)
            </div>
            <div>
                <span>
                    @displayText
                </span>
            </div>
        </div>
    }
}

@if (ba != null)
{
    var baIsRejected = ba.Status == "Rejected";
    var baLineColor = baIsRejected ? "#dc3545" : "#3243c0";
    
    <div class="approval-history-item" style="border-left: 3px solid @baLineColor; padding-left: 1rem; margin-bottom: 2rem;">
        <div class="loan-details-label" style="margin-bottom:0.1em; color: @baLineColor; font-weight: bold;">
            @ba.RoleName Review
        </div>
        <div>
            <span>
                @ba.Status by @ba.ApproverName on @ba.ApprovedDate?.ToString("yyyy-MM-dd")
            </span>
        </div>
    </div>
}

<!-- Co-maker Status -->
@if (coMakerRejected)
{
    <div class="approval-history-item" style="border-left: 3px solid #3243c0; padding-left: 1rem; margin-bottom: 2rem;">
        <div class="loan-details-label" style="margin-bottom:0.1em; color: #dc3545; font-weight: bold;">Co-maker Decision</div>
        <div>
            <span>
                Rejected by @(Model.CoMakerName ?? "Co-maker") on @Model.DateSubmitted.ToString("yyyy-MM-dd")
            </span>
        </div>
    </div>
}
@if (coMakerApproved)
{
    <div class="approval-history-item" style="border-left: 3px solid #3243c0; padding-left: 1rem; margin-bottom: 2rem;">
        <div class="loan-details-label" style="margin-bottom:0.1em; color: #3243c0; font-weight: bold;">Co-maker Decision</div>
        <div>
            <span>
                Approved by @Model.CoMakerName on @Model.DateSubmitted.ToString("yyyy-MM-dd")
            </span>
        </div>
    </div>
}

<!-- Application Submission (always last) -->
<div class="approval-history-submitted" style="border-left: 3px solid #3243c0; padding-left: 1rem; margin-bottom: 2rem;">
    <div class="loan-details-label" style="margin-bottom:0.1em; color: #3243c0; font-weight: bold;">Application Submitted</div>
    <div>
        <span>
            Submitted by @Model.EmployeeName on @Model.DateSubmitted.ToString("yyyy-MM-dd")
        </span>
    </div>
</div>