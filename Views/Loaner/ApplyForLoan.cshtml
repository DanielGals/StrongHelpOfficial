@model StrongHelpOfficial.Models.ApplyForLoanViewModel
@{
    ViewData["Title"] = "Apply For Loan";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var userId = ViewData["UserID"];
    var roleName = ViewData["FirstName"];
    var documentCount = ViewData["DocumentCount"];
    var hasExistingLoan = ViewData["HasExistingLoan"] as bool? ?? false;
    var existingLoanId = ViewData["ExistingLoanId"] as int?;
    var isCoMakerForActiveLoan = ViewData["IsCoMakerForActiveLoan"] as bool? ?? false;
}

@{
    var loanJustSubmitted = TempData["LoanJustSubmitted"] as bool? ?? false;
}

@if (loanJustSubmitted)
{
    <div class="alert alert-success text-center mt-5">
        <h4>Your loan application has been submitted!</h4>
        <p>You can now track your application status.</p>
        <a class="blue-btn mt-3"
           href="@Url.Action("Index", "MyApplication", new { area = "Loaner" })">
            <i class="bi bi-list-ul me-2"></i>View My Loan Details
        </a>
    </div>
    return;
}
else if (isCoMakerForActiveLoan)
{
    <div class="alert alert-warning text-center mt-5">
        <h4>You cannot apply for a loan at this time.</h4>
        <p>You are currently a co-maker for an active loan application. You can apply for your own loan once that application is completed or rejected.</p>
        <a class="blue-btn mt-3"
           href="@Url.Action("Index", "LoanerDashboard", new { area = "Loaner" })">
            <i class="bi bi-house-door me-2"></i>Back to Dashboard
        </a>
    </div>
    return;
}
else if (hasExistingLoan && existingLoanId != null)
{
    <div class="alert alert-warning text-center mt-5">
        <h4>You cannot apply for multiple loans.</h4>
        <p>Would you like to see the details of your loan instead?</p>
        <a class="blue-btn mt-3"
           href="@Url.Action("Index", "MyApplication", new { area = "Loaner" })">
            <i class="bi bi-list-ul me-2"></i>View My Loan Details
        </a>
    </div>
    return;
}

@if (TempData["failedSubmitResult"] != null)
{
    <div class="alert alert-danger" role="alert">
        @TempData["failedSubmitResult"]
    </div>
}

@section Styles {
    <link rel="stylesheet" href="~/css/LoanerDashboard.css" asp-append-version="true" />
}
<h2>Employee Salary Loan</h2>
<p class="text-muted mb-4">Hello @roleName! Upload required documents to submit your loan application</p>

<div class="afl-content">
    <div class="row">
        <div class="col-md-8 mb-3">
            <form id ="loanForm" asp-controller="ApplyForLoan" asp-action="UploadDocuments" method="post" enctype="multipart/form-data">
                <label for="loanAmount" class="form-label fw-bold mb-1">Loan Amount</label>
                <input class="form-control" type="number" asp-for="LoanAmount" id="loanAmount" placeholder="Enter amount" min="10000" max="80000">
                <span asp-validation-for="LoanAmount" class="text-danger"></span>

                <!-- Modal-like box for displaying the requested amount -->
                <div id="loanAmountModalBox" class="alert alert-info mt-3" style="display:none; max-width:350px;">
                    <strong>Your requested loan amount:</strong>
                    <div id="loanAmountDisplay" class="fs-4 mt-2"></div>
                    <div id="loanAmountErrorNote" class="form-text text-muted mt-2" style="display:none;">
                        You cannot loan above eighty-thousand pesos.
                    </div>
                </div>
                <br>
                <div class="upload-container">
                    <h4>Document Upload</h4>
                    <p class="text-muted mb-4">
                        Please upload all required documents to process your application
                    </p>
                    <div class="info-box mb-4">
                        <i class="bi bi-exclamation-circle-fill text-primary fs-4"></i>
                        <div>
                            <h6 class="mb-1">Important</h6>
                            <p class="mb-0">Please ensure all documents are clear, legible, and in PDF format.<br>Documents must be recent and valid</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="mb-4">
                            <div id="drop-area" class="drop-area rounded p-4 text-center text-muted" onclick="document.getElementById('files').click();">
                                Drop files here or click to select
                                <input type="file" accept=".pdf,application/pdf" id="files" name="Files" hidden multiple>
                                <input type="hidden" id="LoanDocumentName" name="LoanDocumentName" value="@Model.LoanDocumentName" />
                                <input type="hidden" id="FileContent" name="FileContent" value="@Model.Filecontent" />
                            </div>
                        </div>
                        <script>
                            let allFiles = [];
                            document.getElementById('files').addEventListener('change', function (event) {
                                const newFiles = Array.from(event.target.files);
                                const errorMsg = document.getElementById('serverErrorMsg');
                                
                                // Check if adding these files would exceed limit
                                if (allFiles.length + newFiles.length > 3) {
                                    errorMsg.textContent = 'Maximum 3 documents allowed.';
                                    errorMsg.style.display = 'block';
                                    event.target.value = "";
                                    return;
                                }
                                
                                let invalid = false;
                                for (const file of newFiles) {
                                    if (file.type !== "application/pdf" && !file.name.toLowerCase().endsWith('.pdf')) {
                                        invalid = true;
                                        break;
                                    }
                                }
                                if (invalid) {
                                    errorMsg.textContent = 'Please upload only PDF files.';
                                    errorMsg.style.display = 'block';
                                    event.target.value = "";
                                    return;
                                }
                                
                                errorMsg.style.display = 'none';
                                for (const file of newFiles) {
                                    if (!allFiles.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified)) {
                                        allFiles.push(file);
                                    }
                                }
                                renderFileList();
                                updateFileInput();
                            });
                            function renderFileList() {
                                const submittedDocs = document.getElementById('submittedDocs');
                                submittedDocs.innerHTML = '<strong class="d-block mb-2">Submitted Documents:</strong>';
                                allFiles.forEach((file, idx) => {
                                    const docItem = document.createElement('div');
                                    docItem.className = 'doc-item d-flex align-items-center justify-content-between';
                                    const input = document.createElement('input');
                                    input.type = 'text';
                                    input.value = file.name;
                                    input.readOnly = true;
                                    input.className = 'form-control';
                                    const deleteBtn = document.createElement('button');
                                    deleteBtn.type = 'button';
                                    deleteBtn.className = 'btn btn-danger btn-sm ms-2';
                                    deleteBtn.innerHTML = '<i class="bi bi-x"></i> Delete';
                                    deleteBtn.onclick = function () {
                                        allFiles.splice(idx, 1);
                                        renderFileList();
                                        updateFileInput();
                                    };
                                    docItem.appendChild(input);
                                    docItem.appendChild(deleteBtn);
                                    submittedDocs.appendChild(docItem);
                                });
                                // Update document count display
                                document.getElementById('documentCountDisplay').textContent = `${allFiles.length}/3 submitted`;
                                // Hide error message if requirements are met
                                const errorMsg = document.getElementById('serverErrorMsg');
                                if (errorMsg && allFiles.length >= 3) {
                                    errorMsg.style.display = 'none';
                                }
                            }
                            function updateFileInput() {
                                const fileInput = document.getElementById('files');
                                const dt = new DataTransfer();
                                allFiles.forEach(file => dt.items.add(file));
                                fileInput.files = dt.files;
                            }
                        </script>
                    </div>
                    <div id="submittedDocs" class="border rounded p-3" style="box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); background-color: white;">
                        <strong class="d-block mb-2">Submitted Documents:</strong>
                    </div>
                    <br />

                    <!-- Co-maker field box start -->
                    <div class="co-maker-box border rounded p-4 mb-4" style="background-color: white;">
                        <h5 class="mb-3 co-maker-title">Add a Co-maker<span class="text-danger">*</span></h5>
                        <div class="co-maker-input-group" style="position:relative;">
                            <input type="text" class="form-control" id="CoMakerName" name="CoMakerName" placeholder="Your co-maker" autocomplete="off" />
                            <input type="hidden" id="CoMakerId" name="CoMakerId" />
                            <div id="coMakerSuggestions" class="list-group"></div>
                        </div>
                        <button type="button" class="action-btn secondary w-25 mt-2" id="setCoMakerBtn">Set as co-maker</button>
                        <div id="coMakerSuccess" class="co-maker-success mt-2" style="display:none;"></div>
                        <div id="coMakerError" class="co-maker-error mt-2" style="display:none;"></div>
                    </div>
                    <!-- Co-maker field box end -->

                </div>
                <br />
                <div id="serverErrorMsg" class="alert alert-danger mt-2" style="display:none;"></div>
                <input class="action-btn primary w-100" type="submit" value="Submit loan" />
            </form>
        </div>
        <div class="col-md-4">
            <div class="guideline-box">
                <h3>Loan Information</h3>
                <p class="mb-3 fc-gray">
                    Important details about our loan offerings and requirements
                </p>
                <p class="mb-1 fw-bold">
                    Required Documents
                </p>
                @if (Model.RequiredDocuments != null && Model.RequiredDocuments.Any())
                {
                    @foreach (var doc in Model.RequiredDocuments)
                    {
                        <p class="mb-0"> • @doc</p>
                    }
                }
                else
                {
                    <p class="mb-0"> • Latest 2 months payslip</p>
                    <p class="mb-0"> • Certificate of Employment</p>
                    <p class="mb-0"> • Valid government-issued ID</p>
                    <p class="mb-0"> • Signed authorization letter from Co-maker</p>
                }
            </div>
        </div>
    </div>
    <div class="submissions-box mb-3">
        <div class="info-item">
            <i class="bi bi-file-earmark-text fs-4 text-secondary"></i>
            <span class="info-text1" id="documentCountDisplay">0/3 submitted</span>
        </div>
        <div class="info-item">
            <i class="bi bi-people-fill fs-4 text-secondary"></i>
            <strong>Co-maker:</strong>
            <span id="coMakerStatusLabel">@ViewData["CoMakerStatus"]</span>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let selectedCoMakerId = null;
        let selectedCoMakerName = "";

        const coMakerNameInput = document.getElementById('CoMakerName');
        const coMakerIdInput = document.getElementById('CoMakerId');
        const coMakerSuggestions = document.getElementById('coMakerSuggestions');
        const setCoMakerBtn = document.getElementById('setCoMakerBtn');
        const coMakerSuccess = document.getElementById('coMakerSuccess');

        if (!coMakerNameInput) return; // Prevents error if element is missing

        coMakerNameInput.addEventListener('input', function() {
            const term = this.value;
            if (term.length < 2) {
                coMakerSuggestions.innerHTML = "";
                return;
            }
            fetch(`/Loaner/ApplyForLoan/SearchUsers?term=${encodeURIComponent(term)}`)
                .then(res => res.json())
                .then(data => {
                    let html = "";
                    data.forEach(user => {
                        html += `<button type="button" class="list-group-item list-group-item-action" onclick="selectCoMaker('${user.userId}', '${user.name.replace(/'/g, "\\'")}')">${user.name}</button>`;
                    });
                    coMakerSuggestions.innerHTML = html;
                });
        });

        window.selectCoMaker = function(userId, name) {
            coMakerNameInput.value = name;
            coMakerIdInput.value = userId;
            selectedCoMakerId = userId;
            selectedCoMakerName = name;
            coMakerSuggestions.innerHTML = "";
            
            // Hide error message when co-maker is selected
            const coMakerError = document.getElementById('coMakerError');
            if (coMakerError) {
                coMakerError.style.display = 'none';
            }
        };

        setCoMakerBtn.addEventListener('click', function() {
            const coMakerError = document.getElementById('coMakerError');
            
            if (selectedCoMakerId && selectedCoMakerName) {
                coMakerSuccess.style.display = "block";
                coMakerSuccess.textContent = `${selectedCoMakerName} is currently chosen as co-maker`;
                coMakerError.style.display = "none";

                // Update the status label below
                const statusLabel = document.getElementById('coMakerStatusLabel');
                if (statusLabel) {
                    statusLabel.textContent = selectedCoMakerName;
                }

                // Hide error message when co-maker is set
                const errorMsg = document.getElementById('serverErrorMsg');
                if (errorMsg) {
                    errorMsg.style.display = 'none';
                }
            } else {
                coMakerSuccess.style.display = "none";
                coMakerError.style.display = "block";
                coMakerError.textContent = "Please select a co-maker from the list.";
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            const box = document.querySelector('.co-maker-box');
            if (box && !box.contains(event.target)) {
                coMakerSuggestions.innerHTML = "";
            }
        });
    });

    let coMakerResults = [];
    let selectedCoMaker = null;

    // Always hide Show More on page load
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('documentCountDisplay').textContent = `${allFiles.length}/3 submitted`;
    });

    function renderCoMakerTable(data, isShowMore) {
        let html = `<table class="table table-bordered align-middle">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>`;
        if (data.length === 0) {
            html += `<tr><td colspan="3" class="text-center">No matching users found.</td></tr>`;
        } else {
            data.forEach(user => {
                html += `<tr>
                    <td>${user.name}</td>
                    <td>${user.department}</td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm" onclick="addCoMaker('${user.userId}', '${user.name}');${isShowMore ? "bootstrap.Modal.getInstance(document.getElementById('showMoreModal')).hide();" : ""}">Add as co-maker</button>
                    </td>
                </tr>`;
            });
        }
        html += `</tbody></table>`;
        if (isShowMore) {
            document.getElementById('showMoreModalBody').innerHTML = html;
        } else {
            document.getElementById('coMakerTableContainer').innerHTML = html;
        }
    }
    // Loan amount modal logic
        document.addEventListener('DOMContentLoaded', function () {
        const loanAmountInput = document.getElementById('loanAmount');
        const modalBox = document.getElementById('loanAmountModalBox');
        const display = document.getElementById('loanAmountDisplay');
        const errorNote = document.getElementById('loanAmountErrorNote');

        loanAmountInput.addEventListener('input', function () {
            const value = parseFloat(this.value);
            if (!isNaN(value) && value > 0) {
                display.textContent = 'PHP ' + value.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                modalBox.style.display = 'block';
                if (value > 80000) {
                    modalBox.classList.remove('alert-info');
                    modalBox.classList.add('alert-danger');
                    errorNote.style.display = 'block';
                    errorNote.textContent = 'You cannot loan beyond eighty-thousand pesos.';
                } 
                else if (value < 10000) {
                    modalBox.classList.remove('alert-info');
                    modalBox.classList.add('alert-danger');
                    errorNote.style.display = 'block';
                    errorNote.textContent = 'You cannot loan below ten-thousand pesos.';
                }
                else {
                    modalBox.classList.remove('alert-danger');
                    modalBox.classList.add('alert-info');
                    errorNote.style.display = 'none';
                }
            } else {
                modalBox.style.display = 'none';
            }
        });
    });
</script>
<!--for the data staying-->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('loanForm');
        const errorMsg = document.getElementById('serverErrorMsg');

        // Restore form data on page load
        restoreFormData();

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            errorMsg.style.display = 'none';
            errorMsg.textContent = '';

            // Save form data before submission
            saveFormData();

            const formData = new FormData(form);

            fetch('@Url.Action("UploadDocuments", "ApplyForLoan", new { area = "Loaner" })', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Clear saved data on success
                        sessionStorage.removeItem('loanFormData');
                        window.location.href = data.redirectUrl;
                    } else {
                        errorMsg.textContent = data.error || "Submission failed.";
                        errorMsg.style.display = 'block';
                    }
                } else {
                    const text = await response.text();
                    errorMsg.textContent = text || "Submission failed.";
                    errorMsg.style.display = 'block';
                }
            })
            .catch(err => {
                errorMsg.textContent = "An error occurred. Please try again.";
                errorMsg.style.display = 'block';
            });
        });

        function saveFormData() {
            const data = {
                loanAmount: document.getElementById('loanAmount').value,
                coMakerId: document.getElementById('CoMakerId').value,
                coMakerName: document.getElementById('CoMakerName').value,
                files: allFiles.map(f => ({ name: f.name, size: f.size, type: f.type, lastModified: f.lastModified }))
            };
            sessionStorage.setItem('loanFormData', JSON.stringify(data));
        }

        function restoreFormData() {
            const saved = sessionStorage.getItem('loanFormData');
            if (!saved) return;

            const data = JSON.parse(saved);
            
            // Restore loan amount
            if (data.loanAmount) {
                document.getElementById('loanAmount').value = data.loanAmount;
                document.getElementById('loanAmount').dispatchEvent(new Event('input'));
            }

            // Restore co-maker
            if (data.coMakerId && data.coMakerName) {
                document.getElementById('CoMakerId').value = data.coMakerId;
                document.getElementById('CoMakerName').value = data.coMakerName;
                selectedCoMakerId = data.coMakerId;
                selectedCoMakerName = data.coMakerName;
                
                // Show co-maker success message
                const coMakerSuccess = document.getElementById('coMakerSuccess');
                coMakerSuccess.style.display = 'block';
                coMakerSuccess.textContent = `${data.coMakerName} is currently chosen as co-maker`;
                
                const statusLabel = document.getElementById('coMakerStatusLabel');
                if (statusLabel) statusLabel.textContent = data.coMakerName;
            }

            // Note: Files cannot be restored due to browser security restrictions
            // Display message about files
            if (data.files && data.files.length > 0) {
                const submittedDocs = document.getElementById('submittedDocs');
                submittedDocs.innerHTML = '<strong class="d-block mb-2">Submitted Documents:</strong>';
                submittedDocs.innerHTML += '<div class="alert alert-warning">Please re-attach your ' + data.files.length + ' document(s): ' + data.files.map(f => f.name).join(', ') + '</div>';
            }
        }
    });
</script>


<style>
    .custom-row {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        background-color: #f0f0f0;
        padding: 5px;
        border-radius: 5px;
    }

    .custom-highlight {
        background-color: #100899;
        color: white;
    }

    .custom-outline {
        background-color: transparent;
        color: gray;
    }

        .custom-highlight:hover,
        .custom-outline:hover {
            background-color: inherit !important;
            color: inherit !important;
            border-color: inherit !important;
        }

    .guideline-box {
        border: none;
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        height: auto;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .fc-gray {
        color: gray;
    }

    .upload-container {
        border: none;
        background-color: white;
        border-radius: 0.75rem;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .info-box {
        background-color: #e7f1ff;
        border: 1px solid #0d6efd;
        border-radius: 0.5rem;
        padding: 1rem;
        color: #0d6efd;
        display: flex;
        align-items: start;
        gap: 1rem;
    }

    .submissions-box {
        border: 1px solid #e0e0e0;
        border-radius: 0.75rem;
        padding: 1rem 1.5rem;
        background-color: white;
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        gap: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-text {
        font-weight: 500;
    }

    .info-text1 {
        font-weight: 500;
    }

    .drop-area {
        border: 2px dashed #6c757d;
        padding: 1.5rem;
        border-radius: 0.5rem;
        text-align: center;
        color: #6c757d;
        cursor: pointer;
    }

        .drop-area.dragover {
            background-color: #e2e6ea;
        }

    .submitted-docs {
        border: 1px solid #ccc;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .doc-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

        .doc-item input {
            flex: 1;
        }

    .blue-btn {
        background-color: #100899 !important; /* matches your custom-highlight blue */
        color: #fff !important;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 0.2s;
        text-decoration: none;
    }
    .blue-btn:hover, .blue-btn:focus {
        background-color: #0a0666 !important;
        color: #fff !important;
        text-decoration: none;
    }

    .co-maker-box {
        position: relative;
        background: white;
        border: 1px solid #e0e0e0 !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .co-maker-input-group {
        position: relative;
    }

    #CoMakerName {
        margin-bottom: 0;
        z-index: 2;
        position: relative;
    }

    #coMakerSuggestions {
        position: absolute;
        top: calc(100% + 0.25rem); /* just below the input */
        left: 0;
        width: 100%;
        z-index: 10;
        background: #fff;
        border: none;
        border-radius: 0 0 0.5rem 0.5rem;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    #coMakerSuggestions:empty {
        display: none;
    }

    .co-maker-success {
        width: 100%;
        background: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        font-weight: 500;
        margin-top: 0.5rem;
        text-align: center;
    }

    .co-maker-error {
        width: 100%;
        background: #f8d7da;
        color: #842029;
        border: 1px solid #f5c2c7;
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        font-weight: 500;
        margin-top: 0.5rem;
        text-align: center;
    }
</style>
