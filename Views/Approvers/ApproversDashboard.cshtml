@model StrongHelpOfficial.Models.ApproverDashboardViewModel
@{
    ViewData["Title"] = $"{Model.RoleName} Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/LoanerDashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/BenefitsAssistantDashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/MyApplication.css" asp-append-version="true" />
}

<div class="dashboard-content">
    <h2 class="fw-bold mb-1">Welcome, @Model.UserName!</h2>
    <p class="text-muted">
        @Model.RoleName Dashboard - Here's an overview of loan applications requiring your approval
    </p>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-clipboard-data"></i>
            </div>
            <div class="stat-content">
                <h3>Total Applications</h3>
                <p class="stat-number">@Model.TotalApplications</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-content">
                <h3>Pending Approval</h3>
                <p class="stat-number">@Model.PendingReview</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-content">
                <h3>Approved Today</h3>
                <p class="stat-number">@Model.ApprovedToday</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-x-circle"></i>
            </div>
            <div class="stat-content">
                <h3>Rejected Today</h3>
                <p class="stat-number">@Model.RejectedToday</p>
            </div>
        </div>
    </div>

    <!-- Search -->
    <div class="mb-4">
        <div class="input-group">
            <span class="input-group-text">
                <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" id="applicationSearch"
                placeholder="Search Applications by employee name or ID..." value="@Model.SearchQuery">
        </div>
    </div>

    <!-- JavaScript for client-side search (SPA style) -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('applicationSearch');
            const tableRows = document.querySelectorAll('table tbody tr:not(.no-results)');
            let noResultsRow = document.querySelector('table tbody tr.no-results');

            if (!noResultsRow) {
                // Create a "no results" row if it doesn't exist
                noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results';
                noResultsRow.style.display = 'none';
                const noResultsCell = document.createElement('td');
                noResultsCell.colSpan = 6;
                noResultsCell.className = 'text-center';
                noResultsCell.textContent = 'No matching applications found';
                noResultsRow.appendChild(noResultsCell);

                if (tableRows.length > 0) {
                    tableRows[0].parentNode.appendChild(noResultsRow);
                }
            }

            // Function to filter table rows based on search term
            function filterApplications() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                let visibleCount = 0;

                tableRows.forEach(row => {
                    const employeeNameCell = row.querySelector('td:nth-child(1)');
                    const loanTypeCell = row.querySelector('td:nth-child(2)');
                    const amountCell = row.querySelector('td:nth-child(3)');
                    const applicationIdText = row.querySelector('a[href*="id="]')?.href.match(/id=(\d+)/)?.[1] || '';

                    if (!employeeNameCell) return; // Skip if row structure is unexpected

                    const employeeName = employeeNameCell.textContent.toLowerCase();
                    const loanType = loanTypeCell?.textContent.toLowerCase() || '';
                    const amount = amountCell?.textContent.toLowerCase() || '';

                    if (searchTerm === '' ||
                        employeeName.includes(searchTerm) ||
                        loanType.includes(searchTerm) ||
                        amount.includes(searchTerm) ||
                        applicationIdText.includes(searchTerm)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Show or hide the "no results" row
                noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
            }

            // Filter applications on keyup with small delay for performance
            searchInput.addEventListener('keyup', function () {
                setTimeout(filterApplications, 100);
            });

            // Initial filter in case there's a search value already
            filterApplications();
        });
    </script>

    <div class="benefits-content-grid">
        <div class="pending-applications-section">
            <h2>Pending Applications</h2>
            <p class="text-muted">Loan Applications awaiting your approval</p>

            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Loan Type</th>
                            <th>Amount</th>
                            <th>Date Applied</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.PendingApplications != null && Model.PendingApplications.Any())
                        {
                            foreach (var app in Model.PendingApplications)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-2">
                                                @app.Initials
                                            </div>
                                            <div>
                                                <div class="fw-semibold">@app.EmployeeName</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@app.LoanType</td>
                                    <td>₱@app.Amount.ToString("N0")</td>
                                    <td>@app.DateApplied.ToString("MMMM d, yyyy")</td>
                                    <td>
                                        @{
                                            string statusClass = app.Status switch
                                            {
                                                "Submitted" => "status-badge status-submitted",
                                                "In Review" => "status-badge status-inreview",
                                                "Approved" => "status-badge status-approved",
                                                "Rejected" => "status-badge status-rejected",
                                                _ => "status-badge status-submitted"
                                            };
                                        }
                                        <span class="@statusClass">
                                            @app.Status
                                        </span>
                                    </td>
                                    <td>
                                        <a href="@Url.Action("Index", "ApproverApplicationDetails", new { id = app.ApplicationId })"
                                            class="btn btn-primary-action">Review</a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">No pending applications</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="text-end mt-2">
                <a href="@Url.Action("Index", "ApproverApplications")" class="btn btn-outline-primary">
                    View All Applications <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>
